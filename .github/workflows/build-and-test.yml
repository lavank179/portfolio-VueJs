name: Build And Test Container
run-name: ${{ github.actor }} is starting the build action.
on:
  push:
    branches:
    - '**'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  TEST_IMAGE: test1.0

jobs:
  Explore-GitHub-Actions:
    runs-on: ubuntu-latest
    steps:
      - run: echo "üéâ The job was automatically triggered by a ${{ github.event_name }} event. By branch- ${{ github.ref }} , repo- ${{ github.repository }} ."
      - name: Check out repository code
        uses: actions/checkout@v4
      - run: echo "üí° The ${{ github.repository }} repository has been cloned to the runner."
      - run: echo "üñ•Ô∏è The workflow is now ready to test your code on the runner."
      - name: List files in the repository
        run: |
          ls ${{ github.workspace }}
      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.6' 
          cache: 'npm'

      - name: Build
        run: |
          sudo chmod +x ./build-and-deploy.sh
          ./build-and-deploy.sh ${{ env.TEST_IMAGE }} deploy 5001
          docker ps
      - name: Test Container has static html page
        run: |
          page="$(curl http://localhost:5001/)"
          error_code=$?
          echo $error_code

          if [[ "$page" == *"I'm a Software Engineer who likes to design and build most scalable and robust applications."* ]]; then
            echo "Found. Container is running well and serving the static page."
          else
            echo "Not found. Some error during build or deploy."
            exit 1 # Fail the actions if not built or deploy.
          fi

      - name: Log in to the Container registry only if publish-image branch
        if: github.ref == 'refs/heads/publish-image'
        uses: docker/login-action@65b78e6e13532edd9afa3aa52ac7964289d1a9c1
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push the image to github registry only if publish-image branch
        if: github.ref == 'refs/heads/publish-image'
        run: |
          push_image_tag=$(echo '${{ env.REGISTRY}}/${{ env.IMAGE_NAME }}:${{ github.run_number }}' | tr '[:upper:]' '[:lower:]')
          docker tag portfolio:${{ env.TEST_IMAGE }} $push_image_tag
          docker images
          docker push $push_image_tag
        
      - name: Cleanup Residuals
        run: |
          EXISTING_CONTAINER=$(docker ps | grep "portfolio" | awk -F " " '{print $1}')
          EXISTING_IMAGE=$(docker images | grep "portfolio" | awk -F " " '{print $3}')
          docker stop $EXISTING_CONTAINER
          docker ps -a
          docker images -a
          docker rmi $EXISTING_IMAGE --force
          echo "Cleanup done."
      
      - name: Npm build for portfolio-repo branch
        # if: github.ref == 'refs/heads/master'
        run: |
          node -v
          npm install
          npm run build
          rm -rf node_modules/
          ls -a dist/*
      - name: Push the build.js and build.js.map to portfolio secret repo
        # if: github.ref == 'refs/heads/master'
        uses: dmnemec/copy_file_to_another_repo_action@main
        env:
          API_TOKEN_GITHUB: ${{ secrets.API_TOKEN_GITHUB }}
        with:
          source_file: 'dist/build.js'
          destination_repo: 'lavank179/portfolio'
          destination_folder: 'portfolio/dist'
          user_email: 'chlavankumar179@gmail.com'
          user_name: 'lavank179'
          commit_message: 'A custom message for the commit'
          destination_branch: 'test-cross-repo-copy'
      - run: echo "Hurray!!! The app is eligible for global deployüçè"
